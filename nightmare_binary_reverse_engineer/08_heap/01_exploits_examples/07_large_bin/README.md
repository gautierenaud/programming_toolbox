# largebin attack

We see here an attack based on large bins, for libc2.31 in my personal case.

The first odd thing I noted is that in order to populate large bin with memory chunks, the tutorial has to first free a consequent chunk, and then allocate a slightly bigger chunk. Only after that the freed chunk will go into large bin. Maybe upon free big memory chunks are just put in the unsortedbin (as the name implies), then when looking for a chunk of the right size from the unsorted bin it will put it in the appropriate bin even if (or more like especially if) it is not suited for the allocation.

Once freed, a chunk in the large bin looks like this:
```gdb
0x555555559290:	0x0000000000000000	0x0000000000000431  <- headers>
0x5555555592a0:	0x00007ffff7fa8fd0	0x00007ffff7fa8fd0  <- ptr to main_arena>
0x5555555592b0:	0x0000555555559290	0x0000555555559290  <- addresses of self ?>
```

On the other hand, unsorted bin will only have a pointer to main_arena.

As for the attack, it will continue by overwriting an address from the chunk in the large bin:
```gdb
0x555555559290:	0x0000000000000000	0x0000000000000431
0x5555555592a0:	0x00007ffff7fa8fd0	0x00007ffff7fa8fd0
0x5555555592b0:	0x0000555555559290	0x00007fffffffdba0  <- we put target-0x20 here>
```

We can see that we changed the 0x5555555592b8 in this instance, which means we need an UAF or a heap overflow. We then put another chunk in the large bin in the same way as before. The first chunk in the large bin will now look like this:
```gdb
0x555555559290:	0x0000000000000000	0x0000000000000431
0x5555555592a0:	0x00005555555596e0	0x00007ffff7fa8fd0  <- ptr to next chunk, then main_arena>
0x5555555592b0:	0x0000555555559290	0x00005555555596e0  <- ptr to self, then next chunk>
```

And the second chunk:
```gdb
0x5555555596e0:	0x0000000000000000	0x0000000000000421
0x5555555596f0:	0x00007ffff7fa8fd0	0x0000555555559290  <- main_arena, previous chunk>
0x555555559700:	0x0000555555559290	0x00007fffffffdba0  <- previous chunk, target-0x20>
```

And now at target we have:
```gdb
gefâž¤  x 0x7fffffffdbc0
0x7fffffffdbc0:	0x00005555555596e0
```

Which is the address of the second chunk in large bin. So at this point this attack seems to be useful when one needs to leak an address or write a big number at a known location.